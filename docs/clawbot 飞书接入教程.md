# 🔷 ClawBot 飞书机器人接入教程

本文档详细介绍如何将 ClawBot 接入飞书，实现飞书群聊/私聊中的 AI 助手功能。

## 📋 前置要求

- 已部署 ClawBotManager 并创建了 Bot
- 飞书账号（个人账号即可，无需企业认证）

## ✨ 特性说明

ClawBot 飞书渠道具有以下特性：

- ✅ **无需公网服务器** - 使用 WebSocket 长连接模式接收消息
- ✅ **无需企业认证** - 个人账号即可创建"企业自建应用"
- ✅ **支持私聊和群聊** - 群聊中 @机器人 触发回复
- ✅ **支持多媒体消息** - 图片、文件等

## 🚀 配置步骤

### 第一步：创建飞书应用

1. 访问 [飞书开放平台](https://open.feishu.cn/)
2. 登录后点击右上角「创建应用」
3. 选择「企业自建应用」（个人账号也可以创建）
4. 填写应用名称（如 "ClawBot"）和描述

### 第二步：添加机器人能力

1. 进入应用详情页
2. 点击左侧菜单「添加应用能力」
3. 找到「机器人」能力，点击添加
4. 确认「机器人」开关已开启

> 💡 **路径**: 开发者后台 → 应用详情 → 添加应用能力 → 机器人

### 第三步：获取应用凭证

在应用详情页的「凭证与基础信息」中，复制以下信息：

- **App ID** - 应用唯一标识（格式：`cli_xxx...`）
- **App Secret** - 应用密钥（点击显示后复制）

⚠️ 请妥善保管 App Secret，不要泄露给他人。

### 第四步：配置权限

1. 点击左侧菜单「权限管理」
2. 搜索并添加以下权限：

| 权限名称 | 权限标识 | 说明 |
|---------|---------|------|
| 获取与发送单聊、群组消息 | `im:message` | 收发消息（必须） |
| 以应用的身份发消息 | `im:message:send_as_bot` | 发送消息（必须） |
| 获取群组信息 | `im:chat:readonly` | 读取群信息（推荐） |
| 获取用户基本信息 | `contact:user.base:readonly` | 获取用户信息（推荐） |

### 第五步：配置事件订阅（长连接模式）

> ⚠️ **重要**: 使用长连接模式无需公网域名，飞书会主动推送消息到客户端。

1. 点击左侧菜单「事件与回调」
2. 选择「**使用长连接接收事件**」（不是 Webhook）
3. 点击「添加事件」，添加以下事件：

| 事件名称 | 事件标识 | 说明 |
|---------|---------|------|
| 接收消息 | `im.message.receive_v1` | 必须 |
| 消息已读 | `im.message.message_read_v1` | 可选 |
| 机器人进群 | `im.chat.member.bot.added_v1` | 可选 |
| 机器人被移出群 | `im.chat.member.bot.deleted_v1` | 可选 |

4. 点击「保存」

> 💡 使用长连接模式**无需填写 Webhook 地址**，无需公网服务器。

### 第六步：发布应用

1. 点击左侧菜单「版本管理与发布」
2. 点击「创建版本」
3. 填写版本号和更新说明
4. 设置可用范围（选择可使用此应用的人/部门）
5. 点击「保存」然后「申请发布」

> 💡 内部应用通常会自动审核通过，无需等待。

### 第七步：在 ClawBotManager 中配置飞书渠道

1. 登录 ClawBotManager 管理后台
2. 进入目标 Bot 的详情页
3. 点击「渠道」标签页
4. 点击「添加渠道」，选择「飞书/Lark」
5. 填写 **App ID** 和 **App Secret**
6. 点击「保存」

### 第八步：添加机器人到群组

**方法一：在飞书客户端添加**

1. 打开飞书，进入目标群组
2. 点击右上角群设置（⚙️ 图标）
3. 点击「群机器人」→「添加机器人」
4. 搜索你的机器人名称并添加

**方法二：创建新群并添加**

1. 创建一个新的群组
2. 在创建时直接添加机器人
3. 或创建后在群设置中添加

## 🧪 测试配置

### 直接在群里测试

1. 在已添加机器人的群组中
2. @机器人 发送消息
3. 等待机器人回复

### 私聊测试

1. 在飞书中搜索机器人名称
2. 点击进入私聊
3. 发送消息测试

## ❓ 常见问题

### Q: 机器人不回复消息？

检查以下几点：

1. **ClawBot 服务是否运行**: 确保 Bot 状态为「运行中」
2. **事件订阅是否配置**: 确保添加了 `im.message.receive_v1` 事件
3. **权限是否完整**: 确保添加了 `im:message` 和 `im:message:send_as_bot` 权限
4. **应用是否发布**: 未发布的应用无法正常使用
5. **机器人是否在群里**: 确保机器人已添加到群组
6. **长连接是否建立**: 检查 ClawBot 日志确认 WebSocket 连接状态

### Q: 群聊中如何触发机器人？

默认情况下，群聊中需要 **@机器人** 才会触发回复，这样可以避免机器人响应所有消息。

### Q: 私聊机器人不回复？

1. 确保你在应用的「可用范围」内
2. 尝试在飞书中搜索机器人名称，点击进入私聊
3. 发送消息测试

### Q: 如何使用国际版 Lark？

如使用国际版 Lark 而非飞书，在配置渠道时选择「Lark (国际版)」或在高级设置中切换域名。

## 🔧 高级配置

### 消息响应策略

| 配置项 | 说明 | 默认值 |
|-------|------|-------|
| `requireMention` | 群聊是否需要 @机器人 | `true` |
| `replyInThread` | 是否在话题中回复 | `false` |
| `showTyping` | 是否显示"正在输入" | `true` |

### 支持的消息类型

| 类型 | 接收 | 发送 | 说明 |
|-----|------|------|------|
| 文本 | ✅ | ✅ | 纯文本消息 |
| 富文本 | ✅ | ✅ | 带格式的文本 |
| 图片 | ✅ | ✅ | 图片消息 |
| 文件 | ✅ | ✅ | 文件附件 |
| 卡片 | ❌ | ✅ | 交互式卡片 |

## 📚 相关链接

- [飞书开放平台](https://open.feishu.cn/)
- [飞书开放平台文档](https://open.feishu.cn/document/)
- [飞书机器人开发指南](https://open.feishu.cn/document/home/develop-a-bot-in-5-minutes/create-an-app)
- [飞书长连接文档](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/event-subscription-guide/long-connection-mode)

---

如有问题，请在 [GitHub Issues](https://github.com/your-repo/clawbot-manager/issues) 中反馈。
