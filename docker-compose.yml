# =============================================================================
# ClawBot Manager - Docker Compose Configuration
# =============================================================================
# Services:
#   - api: NestJS backend (internal: 3200, external: 13100)
#   - web: Next.js frontend (internal: 3000, external: 13000)
#   - botenv: Bot environment image (build profile only)
#
# Prerequisites:
#   - PostgreSQL and Redis should be running externally
#   - Configure DATABASE_URL and REDIS_URL in environment or .env files
#
# Build args (在 .env 中配置，不配置则使用默认值):
#   BASE_NODE_IMAGE: Node 基础镜像
#   OPENCLAW_BASE_IMAGE: OpenClaw 基础镜像 (botenv)
#   NPM_REGISTRY: npm 镜像源 (默认 npmmirror.com)
#
# Troubleshooting network issues during build:
#   1. 如果遇到 ECONNRESET 错误，Dockerfile 会自动重试并回退到官方 npm registry
#   2. 可以手动设置 NPM_REGISTRY=https://registry.npmjs.org 使用官方源
#   3. Docker Desktop: Settings -> Resources -> Proxies -> 关闭或修正代理
#   4. 或在构建前执行: unset HTTP_PROXY HTTPS_PROXY http_proxy https_proxy
#
# Usage:
#   docker compose build                 # Build images only
#   docker compose up -d                 # Start all services (builds if needed)
#   docker compose up -d api web         # Start only api and web
#   docker compose --profile build up    # Build botenv image
# =============================================================================

x-common: &common
  platform: ${DOCKER_PLATFORM:-linux/arm64}
  restart: unless-stopped
  dns:
    - 8.8.8.8
    - 114.114.114.114

x-healthcheck: &healthcheck
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 10s

services:
  # ---------------------------------------------------------------------------
  # Bot Environment Image (build only)
  # ---------------------------------------------------------------------------
  botenv:
    <<: *common
    profiles: ['build']
    build:
      context: .
      dockerfile: Dockerfile.botenv
      args:
        # 来自 .env 中的 OPENCLAW_BASE_IMAGE
        OPENCLAW_BASE_IMAGE: ${OPENCLAW_BASE_IMAGE:-1panel/openclaw:latest}
      network: host
    image: ${BOTENV_IMAGE:-clawbot-env:latest}

  # ---------------------------------------------------------------------------
  # API Service - NestJS Backend
  # ---------------------------------------------------------------------------
  api:
    <<: *common
    build:
      context: .
      dockerfile: Dockerfile
      target: api
      args:
        BASE_NODE_IMAGE: ${BASE_NODE_IMAGE:-node:24.1-slim}
        NPM_REGISTRY: ${NPM_REGISTRY:-https://registry.npmmirror.com}
        # 构建时 prisma generate 需 DATABASE_URL，优先用 apps/api/.env（已放行），或从根 .env 传入
        DATABASE_URL: ${DATABASE_URL:-}
      network: host
    image: clawbot-api:latest
    container_name: clawbot-api
    env_file:
      - ./apps/api/.env
      - ./.env
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 3200
    ports:
      - '${API_PORT:-13100}:3200'
    volumes:
      - api-logs:/app/apps/api/logs
    networks:
      - common_network
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    healthcheck:
      <<: *healthcheck
      test: ['CMD', 'curl', '-f', 'http://localhost:3200/health']

  # ---------------------------------------------------------------------------
  # Web Service - Next.js Frontend
  # ---------------------------------------------------------------------------
  web:
    <<: *common
    build:
      context: .
      dockerfile: Dockerfile
      target: web
      args:
        # 来自 .env 中的 BASE_NODE_IMAGE
        BASE_NODE_IMAGE: ${BASE_NODE_IMAGE:-node:24.1-slim}
        NPM_REGISTRY: ${NPM_REGISTRY:-https://registry.npmmirror.com}
      network: host
    image: clawbot-web:latest
    container_name: clawbot-web
    env_file:
      - ./.env
      - ./apps/web/.env.local
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 3000
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-http://api:3200/api}
    ports:
      - '${WEB_PORT:-13000}:3000'
    depends_on:
      api:
        condition: service_healthy
    networks:
      - common_network
    healthcheck:
      <<: *healthcheck
      test: ['CMD', 'curl', '-f', 'http://localhost:3000']

# =============================================================================
# Networks
# =============================================================================
networks:
  common_network:
    external: true

# =============================================================================
# Volumes
# =============================================================================
volumes:
  api-logs:
    name: clawbot-api-logs
