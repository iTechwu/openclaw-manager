generator client {
  provider        = "prisma-client-js"
  output          = "../generated/prisma-client"
  previewFeatures = ["postgresqlExtensions"]
  binaryTargets   = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider   = "postgresql"
  extensions = [uuid_ossp(map: "uuid-ossp")]
}

// ============================================================================
// User System - ç”¨æˆ·ç³»ç»Ÿ
// ============================================================================
enum SexType {
  UNKNOWN
  MALE
  FEMALE

  @@map("sex_type")
}

model UserInfo {
  id           String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  nickname     String  @default("") @db.VarChar(255)
  code         String? @unique @db.VarChar(255)
  avatarFileId String? @map("avatar_file_id") @db.Uuid
  sex          SexType @default(UNKNOWN)
  locale       String? @db.VarChar(20)
  isAnonymity  Boolean @default(false) @map("is_anonymity")
  isAdmin      Boolean @default(false) @map("is_admin")

  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Account Identifiers (ç™»å½•æ ‡è¯†)
  deviceId      String? @unique @map("device_id") @db.VarChar(255)
  wechatOpenid  String? @unique @map("wechat_openid") @db.VarChar(255)
  wechatUnionId String? @unique @map("wechat_union_id") @db.VarChar(255)
  googleSub     String? @unique @map("google_sub") @db.VarChar(255)
  discordId     String? @unique @map("discord_id") @db.VarChar(255)
  mobile        String? @unique @map("mobile") @db.VarChar(40)
  email         String? @unique @map("email") @db.VarChar(255)

  // Relations
  avatarFile       FileSource?        @relation(fields: [avatarFileId], references: [id], onDelete: SetNull)
  wechatAuth       WechatAuth?
  googleAuth       GoogleAuth?
  discordAuth      DiscordAuth?
  mobileAuth       MobileAuth?
  emailAuth        EmailAuth?
  sentMessages     Message[]          @relation("SentMessages")
  receivedMessages MessageRecipient[] @relation("ReceivedMessages")
  bots             Bot[]
  providerKeys     ProviderKey[]
  personaTemplates PersonaTemplate[]
  operateLogs      OperateLog[]

  @@index([code])
  @@index([isDeleted, isAdmin])
  @@index([createdAt(sort: Desc)])
  @@index([nickname])
  @@index([avatarFileId])
  @@index([deviceId])
  @@index([wechatOpenid])
  @@index([googleSub])
  @@index([discordId])
  @@index([mobile])
  @@index([email])
  @@map("u_user_info")
}

// ============================================================================
// Persona Template System - äººæ ¼æ¨¡æ¿ç³»ç»Ÿï¼ˆé¡»åœ¨ UserInfo åã€è¢«å¼•ç”¨å‰å®šä¹‰ï¼‰
// ============================================================================

/// PersonaTemplate - äººæ ¼æ¨¡æ¿
/// æ”¯æŒç³»ç»Ÿé¢„è®¾æ¨¡æ¿å’Œç”¨æˆ·è‡ªå®šä¹‰æ¨¡æ¿
/// å›¾æ ‡æ”¯æŒä¸¤ç§å½¢å¼ï¼ˆäºŒé€‰ä¸€ï¼‰ï¼š
/// - emoji: emoji å­—ç¬¦ä¸²ï¼ˆå¦‚ "ğŸ¤–"ï¼‰
/// - avatarFileId: ä¸Šä¼ çš„å¤´åƒæ–‡ä»¶ IDï¼ˆå…³è” FileSourceï¼‰
model PersonaTemplate {
  id           String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name         String  @db.VarChar(255)
  emoji        String? @db.VarChar(10)
  avatarFileId String? @map("avatar_file_id") @db.Uuid
  tagline      String  @db.VarChar(500)
  soulMarkdown String  @map("soul_markdown") @db.Text
  soulPreview  String? @map("soul_preview") @db.VarChar(500)
  isSystem     Boolean @default(false) @map("is_system")
  createdById  String? @map("created_by_id") @db.Uuid

  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  createdBy  UserInfo?   @relation(fields: [createdById], references: [id], onDelete: SetNull)
  avatarFile FileSource? @relation(fields: [avatarFileId], references: [id], onDelete: SetNull)
  bots       Bot[]

  @@index([isSystem])
  @@index([createdById])
  @@index([avatarFileId])
  @@index([isDeleted])
  @@index([createdAt(sort: Desc)])
  @@map("b_persona_template")
}

// ============================================================================
// Auth Tables - è®¤è¯ä¿¡æ¯è¡¨ï¼ˆåªå­˜ token/passwordï¼Œä¸å­˜ userIdï¼‰
// ============================================================================

model WechatAuth {
  openid       String    @unique @db.VarChar(255)
  sessionKey   String?   @map("session_key") @db.Text
  refreshToken String?   @map("refresh_token") @db.Text
  isDeleted    Boolean   @default(false) @map("is_deleted")
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz(6)

  user UserInfo @relation(fields: [openid], references: [wechatOpenid], onDelete: Cascade)

  @@index([openid])
  @@map("u_wechat_auth")
}

model GoogleAuth {
  sub           String    @unique @db.VarChar(255)
  email         String    @db.VarChar(255)
  verifiedEmail Boolean   @default(true) @map("verified_email")
  atHash        String?   @map("at_hash") @db.VarChar(255)
  name          String?   @db.VarChar(255)
  picture       String?   @db.Text
  givenName     String?   @map("given_name") @db.VarChar(255)
  familyName    String?   @map("family_name") @db.VarChar(255)
  exp           Int
  iat           Int
  isDeleted     Boolean   @default(false) @map("is_deleted")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz(6)

  user UserInfo @relation(fields: [sub], references: [googleSub], onDelete: Cascade)

  @@index([sub])
  @@index([email])
  @@map("u_google_auth")
}

model DiscordAuth {
  discordId     String    @unique @map("discord_id") @db.VarChar(255)
  email         String    @db.VarChar(255)
  verifiedEmail Boolean   @default(true) @map("verified_email")
  name          String?   @db.VarChar(255)
  accessToken   String?   @map("access_token") @db.Text
  refreshToken  String?   @map("refresh_token") @db.Text
  isDeleted     Boolean   @default(false) @map("is_deleted")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz(6)

  user UserInfo @relation(fields: [discordId], references: [discordId], onDelete: Cascade)

  @@index([discordId])
  @@index([email])
  @@map("u_discord_auth")
}

model MobileAuth {
  mobile    String    @unique @db.VarChar(40)
  password  String    @db.VarChar(255)
  verified  Boolean   @default(false)
  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  user UserInfo @relation(fields: [mobile], references: [mobile], onDelete: Cascade)

  @@index([mobile])
  @@map("u_mobile_auth")
}

model EmailAuth {
  email     String    @unique @db.VarChar(255)
  password  String    @db.VarChar(255)
  verified  Boolean   @default(false)
  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  user UserInfo @relation(fields: [email], references: [email], onDelete: Cascade)

  @@index([email])
  @@map("u_email_auth")
}

// ============================================================================
// Risk Detection - é£é™©æ£€æµ‹è®°å½•
// ============================================================================

model RiskDetectionRecord {
  id        String    @id @db.VarChar(255)
  action    String    @db.VarChar(100)
  data      Json?
  status    Int       @default(0)
  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  @@index([action])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("risk_detection_record")
}

// ============================================================================
// System Task Queue - ç³»ç»Ÿä»»åŠ¡é˜Ÿåˆ—ï¼ˆçŸ­ä¿¡/é‚®ä»¶å‘é€å†å²ï¼‰
// RabbitMQ + BullMQï¼ˆé˜Ÿåˆ—è°ƒåº¦å±‚ï¼‰
// SystemTaskQueue åªåœ¨ä»»åŠ¡æœ€ç»ˆå®Œæˆï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰åå†™å…¥ï¼Œç”¨äºå®¡è®¡ã€ç»Ÿè®¡ã€ç”¨æˆ·æŸ¥è¯¢å‘é€å†å²
// ä¸å‚ä¸é˜Ÿåˆ—è°ƒåº¦å’Œé‡è¯•é€»è¾‘
// ============================================================================

enum TaskType {
  SMS
  EMAIL
  PUSH

  @@map("task_type")
}

enum TaskStatus {
  SUCCESS
  FAILED

  @@map("task_status")
}

model SystemTaskQueue {
  id           String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  taskType     TaskType   @map("task_type")
  status       TaskStatus
  recipient    String     @db.VarChar(255)
  templateCode String?    @map("template_code") @db.VarChar(100)
  templateData Json?      @map("template_data")
  content      String?    @db.Text
  subject      String?    @db.VarChar(500)
  retryCount   Int        @default(0) @map("retry_count")
  processedAt  DateTime   @map("processed_at") @db.Timestamptz(6)
  errorMessage String?    @map("error_message") @db.Text
  metadata     Json?

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([taskType, status])
  @@index([recipient, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@map("system_task_queue")
}

enum FileBucketVendor {
  oss
  us3
  qiniu
  s3
  gcs
  tos
  tencent
  ksyun

  @@map("file_bucket_vendor")
}

enum FileEnvType {
  dev
  test
  prod
  produs
  prodap

  @@map("file_env_type")
}

model FileSource {
  id                        String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  isUploaded                Boolean          @default(false) @map("is_uploaded")
  bucket                    String           @db.VarChar(255)
  key                       String           @unique @db.VarChar(255)
  hash                      String?          @db.VarChar(255)
  thumbImg                  String?          @map("thumb_img") @db.VarChar(255)
  fsize                     Float            @default(0)
  mimeType                  String           @default("") @map("mime_type") @db.VarChar(255)
  type                      Int              @default(0)
  endUser                   String?          @map("end_user") @db.VarChar(255)
  status                    Int              @default(0)
  sha256                    String?          @db.VarChar(255)
  parts                     Int[]
  ext                       String           @default("") @db.VarChar(255)
  expireAt                  DateTime?        @map("expire_at") @db.Timestamptz(6)
  transitionToIaAt          DateTime?        @map("transition_to_ia_at") @db.Timestamptz(6)
  transitionToArchiveAt     DateTime?        @map("transition_to_archive_at") @db.Timestamptz(6)
  transitionToDeepArchiveAt DateTime?        @map("transition_to_deep_archive_at") @db.Timestamptz(6)
  transitionToArchiveIRAt   DateTime?        @map("transition_to_archive_ir_at") @db.Timestamptz(6)
  env                       FileEnvType      @default(prod)
  vendor                    FileBucketVendor @default(us3)
  region                    String           @default("cn-beijing")

  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  userAvatars      UserInfo[]
  personaTemplates PersonaTemplate[]
  botAvatars       Bot[]

  @@index([fsize, sha256])
  @@index([isDeleted])
  @@index([isUploaded])
  @@index([bucket])
  @@index([key])
  @@map("f_file_source")
}

model CountryCode {
  id        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  continent String    @db.VarChar(10) // us, eu, ap, cn
  code      String    @db.VarChar(10) // å›½å®¶ä»£ç ï¼Œå¦‚ CN, US, SG
  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  @@unique([continent, code])
  @@index([continent])
  @@index([code])
  @@map("country_code")
}

// ============================================================================
// Bot Management System - Bot ç®¡ç†ç³»ç»Ÿ
// ============================================================================

enum BotStatus {
  created
  starting
  running
  stopped
  error

  @@map("bot_status")
}

/// Bot - æœºå™¨äººå®ä½“
/// ç®¡ç† AI æœºå™¨äººçš„ç”Ÿå‘½å‘¨æœŸå’Œé…ç½®
model Bot {
  id                String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name              String    @db.VarChar(255)
  hostname          String    @db.VarChar(64)
  aiProvider        String    @map("ai_provider") @db.VarChar(50)
  model             String    @db.VarChar(100)
  channelType       String    @map("channel_type") @db.VarChar(50)
  containerId       String?   @map("container_id") @db.VarChar(255)
  port              Int?
  gatewayToken      String?   @map("gateway_token") @db.VarChar(255)
  proxyTokenHash    String?   @map("proxy_token_hash") @db.VarChar(64)
  tags              String[]
  status            BotStatus @default(created)
  createdById       String    @map("created_by_id") @db.Uuid
  personaTemplateId String?   @map("persona_template_id") @db.Uuid
  emoji             String?   @db.VarChar(10)
  avatarFileId      String?   @map("avatar_file_id") @db.Uuid
  soulMarkdown      String?   @map("soul_markdown") @db.Text

  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  createdBy       UserInfo         @relation(fields: [createdById], references: [id])
  personaTemplate PersonaTemplate? @relation(fields: [personaTemplateId], references: [id], onDelete: SetNull)
  avatarFile      FileSource?      @relation(fields: [avatarFileId], references: [id], onDelete: SetNull)
  providerKeys    BotProviderKey[]
  usageLogs       BotUsageLog[]
  proxyToken      ProxyToken?

  @@index([status])
  @@index([hostname])
  @@index([createdById])
  @@index([personaTemplateId])
  @@index([avatarFileId])
  @@index([isDeleted])
  @@map("b_bot")
}

/// ProviderKey - AI æä¾›å•† API å¯†é’¥
/// å­˜å‚¨åŠ å¯†çš„ API å¯†é’¥ï¼Œæ”¯æŒå¤šæä¾›å•†å’Œæ ‡ç­¾è·¯ç”±
/// ProviderKey - API å¯†é’¥é…ç½®
/// å­˜å‚¨ç”¨æˆ·é…ç½®çš„å„ç±» AI æœåŠ¡å•† API å¯†é’¥
/// æ”¯æŒ OpenAIã€Anthropicã€Googleã€DeepSeek ç­‰ä¸»æµæœåŠ¡å•†ï¼Œä»¥åŠè‡ªå®šä¹‰æœåŠ¡å•†
model ProviderKey {
  /// ä¸»é”® UUID
  id              String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  /// æœåŠ¡å•†æ ‡è¯†ï¼šopenai, anthropic, google, venice, deepseek, groq, custom ç­‰
  vendor          String  @db.VarChar(50)
  /// API åè®®ç±»å‹ï¼šopenai, anthropic, gemini, azure-openai, aws-bedrock, vertexai, ollama, new-api, gateway ç­‰
  /// ç”¨äºç¡®å®š API è°ƒç”¨æ–¹å¼ï¼Œcustom æœåŠ¡å•†å¿…å¡«
  apiType         String? @map("api_type") @db.VarChar(50)
  /// åŠ å¯†å­˜å‚¨çš„ API å¯†é’¥ï¼ˆAES-256-GCM åŠ å¯†ï¼‰
  secretEncrypted Bytes   @map("secret_encrypted")
  /// å¯†é’¥åç§°ï¼ˆå¿…å¡«ï¼‰ï¼Œç”¨äºç”¨æˆ·è¯†åˆ«ä¸åŒå¯†é’¥ï¼ŒåŒä¸€ç”¨æˆ·ä¸‹å”¯ä¸€
  label           String  @db.VarChar(255)
  /// è·¯ç”±æ ‡ç­¾ï¼Œç”¨äºåœ¨å¤šå¯†é’¥åœºæ™¯ä¸‹è¿›è¡Œæµé‡åˆ†é…
  tag             String? @db.VarChar(100)
  /// è‡ªå®šä¹‰ API åœ°å€ï¼Œç”¨äºç§æœ‰éƒ¨ç½²æˆ–ä»£ç†æœåŠ¡
  baseUrl         String? @map("base_url") @db.VarChar(500)
  /// åˆ›å»ºè€…ç”¨æˆ· ID
  createdById     String  @map("created_by_id") @db.Uuid

  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  createdBy       UserInfo         @relation(fields: [createdById], references: [id])
  botProviderKeys BotProviderKey[]
  usageLogs       BotUsageLog[]
  proxyTokens     ProxyToken[]

  @@unique([createdById, label], name: "provider_key_user_label_unique")
  @@index([vendor])
  @@index([apiType])
  @@index([tag])
  @@index([createdById])
  @@index([isDeleted])
  @@map("b_provider_key")
}

/// BotProviderKey - Bot ä¸ ProviderKey çš„å…³è”è¡¨
model BotProviderKey {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  botId         String   @map("bot_id") @db.Uuid
  providerKeyId String   @map("provider_key_id") @db.Uuid
  isPrimary     Boolean  @default(false) @map("is_primary")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  bot         Bot         @relation(fields: [botId], references: [id], onDelete: Cascade)
  providerKey ProviderKey @relation(fields: [providerKeyId], references: [id], onDelete: Cascade)

  @@unique([botId, providerKeyId])
  @@map("b_bot_provider_key")
}

/// BotUsageLog - Bot API ä½¿ç”¨æ—¥å¿—
/// è®°å½•æ¯æ¬¡ API è°ƒç”¨çš„ä½¿ç”¨æƒ…å†µ
model BotUsageLog {
  id             String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  botId          String   @map("bot_id") @db.Uuid
  vendor         String   @db.VarChar(50)
  providerKeyId  String?  @map("provider_key_id") @db.Uuid
  statusCode     Int?     @map("status_code")
  requestTokens  Int?     @map("request_tokens")
  responseTokens Int?     @map("response_tokens")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  bot         Bot          @relation(fields: [botId], references: [id], onDelete: Cascade)
  providerKey ProviderKey? @relation(fields: [providerKeyId], references: [id], onDelete: SetNull)

  @@index([botId])
  @@index([createdAt])
  @@index([vendor])
  @@map("b_usage_log")
}

// ============================================================================
// Zero-Trust Mode - Proxy Token System
// ============================================================================

/// ProxyToken - Zero-Trust æ¨¡å¼çš„ä»£ç†ä»¤ç‰Œ
/// Bot å®¹å™¨ä½¿ç”¨æ­¤ä»¤ç‰Œé€šè¿‡ Proxy è®¿é—® AI APIï¼Œè€Œä¸ç›´æ¥æŒæœ‰ API Key
/// æ ¸å¿ƒå®‰å…¨åŸåˆ™ï¼šBot å®¹å™¨æ°¸è¿œä¸æŒæœ‰çœŸå®çš„ API Key
model ProxyToken {
  id           String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  /// å…³è”çš„ Bot IDï¼ˆä¸€å¯¹ä¸€å…³ç³»ï¼‰
  botId        String    @unique @map("bot_id") @db.Uuid
  /// Token çš„ SHA-256 å“ˆå¸Œå€¼ï¼ˆæ°¸ä¸å­˜å‚¨åŸå§‹ Tokenï¼‰
  tokenHash    String    @unique @map("token_hash") @db.VarChar(64)
  /// AI æœåŠ¡å•†æ ‡è¯†ï¼ˆopenai, anthropic, google ç­‰ï¼‰
  vendor       String    @db.VarChar(50)
  /// å…³è”çš„ ProviderKey ID
  keyId        String    @map("key_id") @db.Uuid
  /// è®¿é—®æ§åˆ¶æ ‡ç­¾
  tags         String[]
  /// Token è¿‡æœŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰
  expiresAt    DateTime? @map("expires_at") @db.Timestamptz(6)
  /// Token æ’¤é”€æ—¶é—´ï¼ˆnull è¡¨ç¤ºæœ‰æ•ˆï¼‰
  revokedAt    DateTime? @map("revoked_at") @db.Timestamptz(6)
  /// æœ€åä½¿ç”¨æ—¶é—´
  lastUsedAt   DateTime? @map("last_used_at") @db.Timestamptz(6)
  /// è¯·æ±‚è®¡æ•°
  requestCount Int       @default(0) @map("request_count")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  bot         Bot         @relation(fields: [botId], references: [id], onDelete: Cascade)
  providerKey ProviderKey @relation(fields: [keyId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([botId])
  @@index([keyId])
  @@index([vendor])
  @@index([expiresAt])
  @@index([revokedAt])
  @@map("b_proxy_token")
}

/// User Message System
/// ç”¨æˆ·æ¶ˆæ¯ç³»ç»Ÿ - æ”¯æŒç³»ç»Ÿé€šçŸ¥ã€ç”¨æˆ·é—´æ¶ˆæ¯ç­‰
model Message {
  id        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  type      String    @db.VarChar(50) // SYSTEM, USER, NOTIFICATION, MILESTONE, ACHIEVEMENT
  title     String?   @db.VarChar(255)
  content   Json // æ¶ˆæ¯å†…å®¹ï¼ˆæ”¯æŒå¯Œæ–‡æœ¬ã€å¤šè¯­è¨€ï¼‰
  senderId  String?   @map("sender_id") @db.Uuid // null for system messages
  metadata  Json? // é¢å¤–å…ƒæ•°æ®ï¼ˆå¦‚å…³è”çš„é—®é¢˜IDã€å¾½ç« IDç­‰ï¼‰
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  isDeleted Boolean   @default(false) @map("is_deleted")
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  sender     UserInfo?          @relation("SentMessages", fields: [senderId], references: [id], onDelete: SetNull)
  recipients MessageRecipient[]

  @@index([type])
  @@index([senderId])
  @@index([createdAt])
  @@index([isDeleted])
  @@map("message")
}

/// Message Recipient - æ¶ˆæ¯æ¥æ”¶è®°å½•
/// è®°å½•æ¯ä¸ªç”¨æˆ·æ¥æ”¶åˆ°çš„æ¶ˆæ¯åŠå…¶é˜…è¯»çŠ¶æ€
model MessageRecipient {
  id        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  messageId String    @map("message_id") @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  isRead    Boolean   @default(false) @map("is_read")
  readAt    DateTime? @map("read_at") @db.Timestamptz(6)

  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  isDeleted Boolean   @default(false) @map("is_deleted")
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  message Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    UserInfo @relation("ReceivedMessages", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([userId, isRead])
  @@index([messageId])
  @@index([isDeleted])
  @@index([userId, isRead, isDeleted]) // Composite index for unread message count queries
  @@map("message_recipient")
}

// ============================================================================
// Operation Log System - æ“ä½œæ—¥å¿—ç³»ç»Ÿ
// ============================================================================

enum OperateType {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  START
  STOP
  EXPORT
  IMPORT

  @@map("operate_type")
}

enum OperateTarget {
  BOT
  PROVIDER_KEY
  USER
  PERSONA_TEMPLATE
  SYSTEM

  @@map("operate_target")
}

/// OperateLog - æ“ä½œæ—¥å¿—
/// è®°å½•ç”¨æˆ·çš„æ“ä½œè¡Œä¸ºï¼Œç”¨äºå®¡è®¡å’Œè¿½è¸ª
model OperateLog {
  id          String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId      String        @map("user_id") @db.Uuid
  operateType OperateType   @map("operate_type")
  target      OperateTarget
  targetId    String?       @map("target_id") @db.Uuid
  targetName  String?       @map("target_name") @db.VarChar(255)
  detail      Json?
  ipAddress   String?       @map("ip_address") @db.VarChar(45)
  userAgent   String?       @map("user_agent") @db.VarChar(500)
  createdAt   DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)

  user UserInfo @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([operateType])
  @@index([target])
  @@index([targetId])
  @@index([createdAt(sort: Desc)])
  @@map("operate_log")
}

// ============================================================================
// Channel Definition System - æ¸ é“å®šä¹‰ç³»ç»Ÿ
// ============================================================================

/// ChannelDefinition - æ¸ é“å®šä¹‰
/// å­˜å‚¨å„ç§æ¶ˆæ¯æ¸ é“çš„é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ‰€éœ€çš„å‡­è¯å­—æ®µ
model ChannelDefinition {
  id               String  @id @db.VarChar(50) // e.g., "feishu", "telegram", "discord"
  label            String  @db.VarChar(100) // Display name
  icon             String  @db.VarChar(10) // Emoji or short icon code
  popular          Boolean @default(false) // Whether to show in popular section
  tokenHint        String  @map("token_hint") @db.VarChar(500) // Help text for token
  tokenPlaceholder String  @map("token_placeholder") @db.VarChar(255) // Placeholder text
  helpUrl          String? @map("help_url") @db.VarChar(500) // Documentation URL
  helpText         String? @map("help_text") @db.VarChar(255) // Help link text
  sortOrder        Int     @default(0) @map("sort_order") // Display order

  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  credentialFields ChannelCredentialField[]

  @@index([popular])
  @@index([sortOrder])
  @@index([isDeleted])
  @@map("b_channel_definition")
}

/// ChannelCredentialField - æ¸ é“å‡­è¯å­—æ®µ
/// å®šä¹‰æ¯ä¸ªæ¸ é“æ‰€éœ€çš„å‡­è¯å­—æ®µé…ç½®
model ChannelCredentialField {
  id          String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  channelId   String  @map("channel_id") @db.VarChar(50)
  key         String  @db.VarChar(50) // Field key, e.g., "appId", "appSecret"
  label       String  @db.VarChar(100) // Display label
  placeholder String  @db.VarChar(255) // Placeholder text
  fieldType   String  @default("text") @map("field_type") @db.VarChar(20) // "text" or "password"
  required    Boolean @default(true) // Whether field is required
  sortOrder   Int     @default(0) @map("sort_order") // Display order within channel

  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  channel ChannelDefinition @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([channelId, key])
  @@index([channelId])
  @@index([sortOrder])
  @@index([isDeleted])
  @@map("b_channel_credential_field")
}
