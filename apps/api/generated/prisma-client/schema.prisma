generator client {
  provider        = "prisma-client-js"
  output          = "../generated/prisma-client"
  previewFeatures = ["postgresqlExtensions"]
  binaryTargets   = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider   = "postgresql"
  extensions = [uuid_ossp(map: "uuid-ossp")]
}

// ============================================================================
// User System - ç”¨æˆ·ç³»ç»Ÿ
// ============================================================================
enum SexType {
  UNKNOWN
  MALE
  FEMALE

  @@map("sex_type")
}

model UserInfo {
  id           String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  nickname     String  @default("") @db.VarChar(255)
  code         String? @unique @db.VarChar(255)
  avatarFileId String? @map("avatar_file_id") @db.Uuid
  sex          SexType @default(UNKNOWN)
  locale       String? @db.VarChar(20)
  isAnonymity  Boolean @default(false) @map("is_anonymity")
  isAdmin      Boolean @default(false) @map("is_admin")

  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Account Identifiers (ç™»å½•æ ‡è¯†)
  deviceId      String? @unique @map("device_id") @db.VarChar(255)
  wechatOpenid  String? @unique @map("wechat_openid") @db.VarChar(255)
  wechatUnionId String? @unique @map("wechat_union_id") @db.VarChar(255)
  googleSub     String? @unique @map("google_sub") @db.VarChar(255)
  discordId     String? @unique @map("discord_id") @db.VarChar(255)
  mobile        String? @unique @map("mobile") @db.VarChar(40)
  email         String? @unique @map("email") @db.VarChar(255)

  // Relations
  avatarFile       FileSource?        @relation(fields: [avatarFileId], references: [id], onDelete: SetNull)
  wechatAuth       WechatAuth?
  googleAuth       GoogleAuth?
  discordAuth      DiscordAuth?
  mobileAuth       MobileAuth?
  emailAuth        EmailAuth?
  sentMessages     Message[]          @relation("SentMessages")
  receivedMessages MessageRecipient[] @relation("ReceivedMessages")
  bots             Bot[]
  providerKeys     ProviderKey[]
  personaTemplates PersonaTemplate[]
  operateLogs      OperateLog[]

  @@index([code])
  @@index([isDeleted, isAdmin])
  @@index([createdAt(sort: Desc)])
  @@index([nickname])
  @@index([avatarFileId])
  @@index([deviceId])
  @@index([wechatOpenid])
  @@index([googleSub])
  @@index([discordId])
  @@index([mobile])
  @@index([email])
  @@map("u_user_info")
}

// ============================================================================
// Persona Template System - äººæ ¼æ¨¡æ¿ç³»ç»Ÿï¼ˆé¡»åœ¨ UserInfo åã€è¢«å¼•ç”¨å‰å®šä¹‰ï¼‰
// ============================================================================

/// PersonaTemplate - äººæ ¼æ¨¡æ¿
/// æ”¯æŒç³»ç»Ÿé¢„è®¾æ¨¡æ¿å’Œç”¨æˆ·è‡ªå®šä¹‰æ¨¡æ¿
/// å›¾æ ‡æ”¯æŒä¸¤ç§å½¢å¼ï¼ˆäºŒé€‰ä¸€ï¼‰ï¼š
/// - emoji: emoji å­—ç¬¦ä¸²ï¼ˆå¦‚ "ğŸ¤–"ï¼‰
/// - avatarFileId: ä¸Šä¼ çš„å¤´åƒæ–‡ä»¶ IDï¼ˆå…³è” FileSourceï¼‰
model PersonaTemplate {
  id           String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name         String  @db.VarChar(255)
  emoji        String? @db.VarChar(10)
  avatarFileId String? @map("avatar_file_id") @db.Uuid
  tagline      String  @db.VarChar(500)
  soulMarkdown String  @map("soul_markdown") @db.Text
  soulPreview  String? @map("soul_preview") @db.VarChar(500)
  isSystem     Boolean @default(false) @map("is_system")
  locale       String  @default("en") @db.VarChar(10) // en, zh-CN
  createdById  String? @map("created_by_id") @db.Uuid

  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  createdBy  UserInfo?   @relation(fields: [createdById], references: [id], onDelete: SetNull)
  avatarFile FileSource? @relation(fields: [avatarFileId], references: [id], onDelete: SetNull)
  bots       Bot[]

  @@index([isSystem])
  @@index([createdById])
  @@index([avatarFileId])
  @@index([isDeleted])
  @@index([locale])
  @@index([createdAt(sort: Desc)])
  @@map("b_persona_template")
}

// ============================================================================
// Auth Tables - è®¤è¯ä¿¡æ¯è¡¨ï¼ˆåªå­˜ token/passwordï¼Œä¸å­˜ userIdï¼‰
// ============================================================================

model WechatAuth {
  openid       String    @unique @db.VarChar(255)
  sessionKey   String?   @map("session_key") @db.Text
  refreshToken String?   @map("refresh_token") @db.Text
  isDeleted    Boolean   @default(false) @map("is_deleted")
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz(6)

  user UserInfo @relation(fields: [openid], references: [wechatOpenid], onDelete: Cascade)

  @@index([openid])
  @@map("u_wechat_auth")
}

model GoogleAuth {
  sub           String    @unique @db.VarChar(255)
  email         String    @db.VarChar(255)
  verifiedEmail Boolean   @default(true) @map("verified_email")
  atHash        String?   @map("at_hash") @db.VarChar(255)
  name          String?   @db.VarChar(255)
  picture       String?   @db.Text
  givenName     String?   @map("given_name") @db.VarChar(255)
  familyName    String?   @map("family_name") @db.VarChar(255)
  exp           Int
  iat           Int
  isDeleted     Boolean   @default(false) @map("is_deleted")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz(6)

  user UserInfo @relation(fields: [sub], references: [googleSub], onDelete: Cascade)

  @@index([sub])
  @@index([email])
  @@map("u_google_auth")
}

model DiscordAuth {
  discordId     String    @unique @map("discord_id") @db.VarChar(255)
  email         String    @db.VarChar(255)
  verifiedEmail Boolean   @default(true) @map("verified_email")
  name          String?   @db.VarChar(255)
  accessToken   String?   @map("access_token") @db.Text
  refreshToken  String?   @map("refresh_token") @db.Text
  isDeleted     Boolean   @default(false) @map("is_deleted")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz(6)

  user UserInfo @relation(fields: [discordId], references: [discordId], onDelete: Cascade)

  @@index([discordId])
  @@index([email])
  @@map("u_discord_auth")
}

model MobileAuth {
  mobile    String    @unique @db.VarChar(40)
  password  String    @db.VarChar(255)
  verified  Boolean   @default(false)
  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  user UserInfo @relation(fields: [mobile], references: [mobile], onDelete: Cascade)

  @@index([mobile])
  @@map("u_mobile_auth")
}

model EmailAuth {
  email     String    @unique @db.VarChar(255)
  password  String    @db.VarChar(255)
  verified  Boolean   @default(false)
  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  user UserInfo @relation(fields: [email], references: [email], onDelete: Cascade)

  @@index([email])
  @@map("u_email_auth")
}

// ============================================================================
// Risk Detection - é£é™©æ£€æµ‹è®°å½•
// ============================================================================

model RiskDetectionRecord {
  id        String    @id @db.VarChar(255)
  action    String    @db.VarChar(100)
  data      Json?
  status    Int       @default(0)
  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  @@index([action])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("risk_detection_record")
}

// ============================================================================
// System Task Queue - ç³»ç»Ÿä»»åŠ¡é˜Ÿåˆ—ï¼ˆçŸ­ä¿¡/é‚®ä»¶å‘é€å†å²ï¼‰
// RabbitMQ + BullMQï¼ˆé˜Ÿåˆ—è°ƒåº¦å±‚ï¼‰
// SystemTaskQueue åªåœ¨ä»»åŠ¡æœ€ç»ˆå®Œæˆï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰åå†™å…¥ï¼Œç”¨äºå®¡è®¡ã€ç»Ÿè®¡ã€ç”¨æˆ·æŸ¥è¯¢å‘é€å†å²
// ä¸å‚ä¸é˜Ÿåˆ—è°ƒåº¦å’Œé‡è¯•é€»è¾‘
// ============================================================================

enum TaskType {
  SMS
  EMAIL
  PUSH

  @@map("task_type")
}

enum TaskStatus {
  SUCCESS
  FAILED

  @@map("task_status")
}

model SystemTaskQueue {
  id           String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  taskType     TaskType   @map("task_type")
  status       TaskStatus
  recipient    String     @db.VarChar(255)
  templateCode String?    @map("template_code") @db.VarChar(100)
  templateData Json?      @map("template_data")
  content      String?    @db.Text
  subject      String?    @db.VarChar(500)
  retryCount   Int        @default(0) @map("retry_count")
  processedAt  DateTime   @map("processed_at") @db.Timestamptz(6)
  errorMessage String?    @map("error_message") @db.Text
  metadata     Json?

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([taskType, status])
  @@index([recipient, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@map("system_task_queue")
}

enum FileBucketVendor {
  oss
  us3
  qiniu
  s3
  gcs
  tos
  tencent
  ksyun

  @@map("file_bucket_vendor")
}

enum FileEnvType {
  dev
  test
  prod
  produs
  prodap

  @@map("file_env_type")
}

model FileSource {
  id                        String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  isUploaded                Boolean          @default(false) @map("is_uploaded")
  bucket                    String           @db.VarChar(255)
  key                       String           @unique @db.VarChar(255)
  hash                      String?          @db.VarChar(255)
  thumbImg                  String?          @map("thumb_img") @db.VarChar(255)
  fsize                     Float            @default(0)
  mimeType                  String           @default("") @map("mime_type") @db.VarChar(255)
  type                      Int              @default(0)
  endUser                   String?          @map("end_user") @db.VarChar(255)
  status                    Int              @default(0)
  sha256                    String?          @db.VarChar(255)
  parts                     Int[]
  ext                       String           @default("") @db.VarChar(255)
  expireAt                  DateTime?        @map("expire_at") @db.Timestamptz(6)
  transitionToIaAt          DateTime?        @map("transition_to_ia_at") @db.Timestamptz(6)
  transitionToArchiveAt     DateTime?        @map("transition_to_archive_at") @db.Timestamptz(6)
  transitionToDeepArchiveAt DateTime?        @map("transition_to_deep_archive_at") @db.Timestamptz(6)
  transitionToArchiveIRAt   DateTime?        @map("transition_to_archive_ir_at") @db.Timestamptz(6)
  env                       FileEnvType      @default(prod)
  vendor                    FileBucketVendor @default(us3)
  region                    String           @default("cn-beijing")

  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  userAvatars      UserInfo[]
  personaTemplates PersonaTemplate[]
  botAvatars       Bot[]

  @@index([fsize, sha256])
  @@index([isDeleted])
  @@index([isUploaded])
  @@index([bucket])
  @@index([key])
  @@map("f_file_source")
}

model CountryCode {
  id        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  continent String    @db.VarChar(10) // us, eu, ap, cn
  code      String    @db.VarChar(10) // å›½å®¶ä»£ç ï¼Œå¦‚ CN, US, SG
  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  @@unique([continent, code])
  @@index([continent])
  @@index([code])
  @@map("country_code")
}

// ============================================================================
// Bot Management System - Bot ç®¡ç†ç³»ç»Ÿ
// ============================================================================

enum BotStatus {
  draft // è‰ç¨¿çŠ¶æ€ï¼Œæœªé…ç½®å®Œæˆ
  created
  starting
  running
  stopped
  error

  @@map("bot_status")
}

/// Bot å¥åº·çŠ¶æ€
enum HealthStatus {
  HEALTHY
  UNHEALTHY
  UNKNOWN

  @@map("health_status")
}

/// Bot - æœºå™¨äººå®ä½“
/// ç®¡ç† AI æœºå™¨äººçš„ç”Ÿå‘½å‘¨æœŸå’Œé…ç½®
/// æ³¨æ„ï¼šaiProviderã€modelã€channelType å­—æ®µå·²ç§»é™¤ï¼Œè¿™äº›å€¼ä» BotProviderKey å’Œ BotChannel åŠ¨æ€æ´¾ç”Ÿ
model Bot {
  id                String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name              String    @db.VarChar(255)
  hostname          String    @db.VarChar(64)
  containerId       String?   @map("container_id") @db.VarChar(255)
  port              Int?
  gatewayToken      String?   @map("gateway_token") @db.VarChar(255)
  proxyTokenHash    String?   @map("proxy_token_hash") @db.VarChar(64)
  tags              String[]
  status            BotStatus @default(created)
  createdById       String    @map("created_by_id") @db.Uuid
  personaTemplateId String?   @map("persona_template_id") @db.Uuid
  emoji             String?   @db.VarChar(10)
  avatarFileId      String?   @map("avatar_file_id") @db.Uuid
  soulMarkdown      String?   @map("soul_markdown") @db.Text

  // å¾…ç”Ÿæ•ˆé…ç½®ï¼šå­˜å‚¨ä¿®æ”¹åå°šæœªé‡å¯ç”Ÿæ•ˆçš„é…ç½®
  // åŒ…å« name, tags, soulMarkdown, emoji ç­‰å­—æ®µçš„å¾…ç”Ÿæ•ˆå€¼
  pendingConfig Json? @map("pending_config") @db.JsonB

  // å¥åº·æ£€æŸ¥å­—æ®µ
  healthStatus    HealthStatus @default(UNKNOWN) @map("health_status")
  lastHealthCheck DateTime?    @map("last_health_check") @db.Timestamptz(6)

  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  createdBy       UserInfo          @relation(fields: [createdById], references: [id])
  personaTemplate PersonaTemplate?  @relation(fields: [personaTemplateId], references: [id], onDelete: SetNull)
  avatarFile      FileSource?       @relation(fields: [avatarFileId], references: [id], onDelete: SetNull)
  providerKeys    BotProviderKey[]
  usageLogs       BotUsageLog[]
  proxyToken      ProxyToken?
  plugins         BotPlugin[]
  skills          BotSkill[]
  channels        BotChannel[]
  modelRoutings   BotModelRouting[]
  routingConfig   BotRoutingConfig?

  @@index([status])
  @@index([hostname])
  @@index([createdById])
  @@index([personaTemplateId])
  @@index([avatarFileId])
  @@index([isDeleted])
  @@index([healthStatus])
  @@map("b_bot")
}

/// ProviderKey - AI æä¾›å•† API å¯†é’¥
/// å­˜å‚¨åŠ å¯†çš„ API å¯†é’¥ï¼Œæ”¯æŒå¤šæä¾›å•†å’Œæ ‡ç­¾è·¯ç”±
/// ProviderKey - API å¯†é’¥é…ç½®
/// å­˜å‚¨ç”¨æˆ·é…ç½®çš„å„ç±» AI æœåŠ¡å•† API å¯†é’¥
/// æ”¯æŒ OpenAIã€Anthropicã€Googleã€DeepSeek ç­‰ä¸»æµæœåŠ¡å•†ï¼Œä»¥åŠè‡ªå®šä¹‰æœåŠ¡å•†
model ProviderKey {
  /// ä¸»é”® UUID
  id              String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  /// æœåŠ¡å•†æ ‡è¯†ï¼šopenai, anthropic, google, venice, deepseek, groq, custom ç­‰
  vendor          String  @db.VarChar(50)
  /// API åè®®ç±»å‹ï¼šopenai, anthropic, gemini, azure-openai, aws-bedrock, vertexai, ollama, new-api, gateway ç­‰
  /// ç”¨äºç¡®å®š API è°ƒç”¨æ–¹å¼ï¼Œcustom æœåŠ¡å•†å¿…å¡«
  apiType         String? @map("api_type") @db.VarChar(50)
  /// åŠ å¯†å­˜å‚¨çš„ API å¯†é’¥ï¼ˆAES-256-GCM åŠ å¯†ï¼‰
  secretEncrypted Bytes   @map("secret_encrypted")
  /// å¯†é’¥åç§°ï¼ˆå¿…å¡«ï¼‰ï¼Œç”¨äºç”¨æˆ·è¯†åˆ«ä¸åŒå¯†é’¥ï¼ŒåŒä¸€ç”¨æˆ·ä¸‹å”¯ä¸€
  label           String  @db.VarChar(255)
  /// è·¯ç”±æ ‡ç­¾ï¼Œç”¨äºåœ¨å¤šå¯†é’¥åœºæ™¯ä¸‹è¿›è¡Œæµé‡åˆ†é…
  tag             String? @db.VarChar(100)
  /// è‡ªå®šä¹‰ API åœ°å€ï¼Œç”¨äºç§æœ‰éƒ¨ç½²æˆ–ä»£ç†æœåŠ¡
  baseUrl         String? @map("base_url") @db.VarChar(500)
  /// åˆ›å»ºè€…ç”¨æˆ· ID
  createdById     String  @map("created_by_id") @db.Uuid

  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  createdBy       UserInfo         @relation(fields: [createdById], references: [id])
  botProviderKeys BotProviderKey[]
  usageLogs       BotUsageLog[]
  proxyTokens     ProxyToken[]

  @@unique([createdById, label], name: "provider_key_user_label_unique")
  @@index([vendor])
  @@index([apiType])
  @@index([tag])
  @@index([createdById])
  @@index([isDeleted])
  @@map("b_provider_key")
}

/// BotProviderKey - Bot ä¸ ProviderKey çš„å…³è”è¡¨
/// å­˜å‚¨ Bot ä¸ ProviderKey çš„å…³è”å…³ç³»ï¼Œä»¥åŠè¯¥å…³è”å…è®¸ä½¿ç”¨çš„æ¨¡å‹åˆ—è¡¨
model BotProviderKey {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  botId         String   @map("bot_id") @db.Uuid
  providerKeyId String   @map("provider_key_id") @db.Uuid
  isPrimary     Boolean  @default(false) @map("is_primary")
  /// å…è®¸ä½¿ç”¨çš„æ¨¡å‹åˆ—è¡¨
  allowedModels String[] @default([]) @map("allowed_models")
  /// ä¸»è¦æ¨¡å‹ï¼ˆé»˜è®¤ä½¿ç”¨çš„æ¨¡å‹ï¼‰
  primaryModel  String?  @map("primary_model") @db.VarChar(100)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  bot         Bot         @relation(fields: [botId], references: [id], onDelete: Cascade)
  providerKey ProviderKey @relation(fields: [providerKeyId], references: [id], onDelete: Cascade)

  @@unique([botId, providerKeyId])
  @@map("b_bot_provider_key")
}

/// BotUsageLog - Bot API ä½¿ç”¨æ—¥å¿—
/// è®°å½•æ¯æ¬¡ API è°ƒç”¨çš„ä½¿ç”¨æƒ…å†µ
model BotUsageLog {
  id             String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  botId          String   @map("bot_id") @db.Uuid
  vendor         String   @db.VarChar(50)
  providerKeyId  String?  @map("provider_key_id") @db.Uuid
  statusCode     Int?     @map("status_code")
  requestTokens  Int?     @map("request_tokens")
  responseTokens Int?     @map("response_tokens")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // åŸºç¡€å­—æ®µ - ç”¨äºç²¾ç»†åŒ–ç”¨é‡åˆ†æ
  model        String? @db.VarChar(100) // AI æ¨¡å‹åç§°
  endpoint     String? @db.VarChar(255) // API ç«¯ç‚¹è·¯å¾„
  durationMs   Int?    @map("duration_ms") // è¯·æ±‚è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
  errorMessage String? @map("error_message") @db.Text // é”™è¯¯ä¿¡æ¯

  // ============ æ··åˆæ¶æ„æ‰©å±•å­—æ®µ ============
  // åŸç”ŸåŠŸèƒ½ä½¿ç”¨è¿½è¸ª
  /// Extended Thinking tokens
  thinkingTokens   Int? @map("thinking_tokens")
  /// Cache Control è¯»å– tokens
  cacheReadTokens  Int? @map("cache_read_tokens")
  /// Cache Control å†™å…¥ tokens
  cacheWriteTokens Int? @map("cache_write_tokens")

  /// åè®®ç±»å‹ï¼šopenai-compatible | anthropic-native | gemini-native
  protocolType String? @map("protocol_type") @db.VarChar(50)

  // æˆæœ¬è¿½è¸ªï¼ˆç¾å…ƒï¼‰
  /// è¾“å…¥æˆæœ¬
  inputCost    Decimal? @map("input_cost") @db.Decimal(10, 6)
  /// è¾“å‡ºæˆæœ¬
  outputCost   Decimal? @map("output_cost") @db.Decimal(10, 6)
  /// æ€è€ƒæˆæœ¬
  thinkingCost Decimal? @map("thinking_cost") @db.Decimal(10, 6)
  /// ç¼“å­˜æˆæœ¬
  cacheCost    Decimal? @map("cache_cost") @db.Decimal(10, 6)
  /// æ€»æˆæœ¬
  totalCost    Decimal? @map("total_cost") @db.Decimal(10, 6)

  // Fallback è¿½è¸ª
  /// æ˜¯å¦ä½¿ç”¨äº† Fallback
  fallbackUsed  Boolean? @map("fallback_used")
  /// Fallback çº§åˆ«ï¼ˆ0=ä¸»æ¨¡å‹ï¼Œ1=ç¬¬ä¸€å¤‡ç”¨ï¼Œä»¥æ­¤ç±»æ¨ï¼‰
  fallbackLevel Int?     @map("fallback_level")
  /// åŸå§‹è¯·æ±‚æ¨¡å‹
  originalModel String?  @map("original_model") @db.VarChar(100)

  bot         Bot          @relation(fields: [botId], references: [id], onDelete: Cascade)
  providerKey ProviderKey? @relation(fields: [providerKeyId], references: [id], onDelete: SetNull)

  @@index([botId])
  @@index([createdAt])
  @@index([vendor])
  @@index([botId, createdAt]) // å¤åˆç´¢å¼•ï¼šæŒ‰ Bot æŸ¥è¯¢æ—¶é—´èŒƒå›´
  @@index([botId, vendor, createdAt]) // å¤åˆç´¢å¼•ï¼šæŒ‰ Bot+Vendor æŸ¥è¯¢
  @@index([model]) // æŒ‰æ¨¡å‹æŸ¥è¯¢
  @@index([protocolType]) // æŒ‰åè®®ç±»å‹æŸ¥è¯¢
  @@index([fallbackUsed]) // æŒ‰ Fallback ä½¿ç”¨æƒ…å†µæŸ¥è¯¢
  @@map("b_usage_log")
}

// ============================================================================
// Zero-Trust Mode - Proxy Token System
// ============================================================================

/// ProxyToken - Zero-Trust æ¨¡å¼çš„ä»£ç†ä»¤ç‰Œ
/// Bot å®¹å™¨ä½¿ç”¨æ­¤ä»¤ç‰Œé€šè¿‡ Proxy è®¿é—® AI APIï¼Œè€Œä¸ç›´æ¥æŒæœ‰ API Key
/// æ ¸å¿ƒå®‰å…¨åŸåˆ™ï¼šBot å®¹å™¨æ°¸è¿œä¸æŒæœ‰çœŸå®çš„ API Key
model ProxyToken {
  id           String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  /// å…³è”çš„ Bot IDï¼ˆä¸€å¯¹ä¸€å…³ç³»ï¼‰
  botId        String    @unique @map("bot_id") @db.Uuid
  /// Token çš„ SHA-256 å“ˆå¸Œå€¼ï¼ˆæ°¸ä¸å­˜å‚¨åŸå§‹ Tokenï¼‰
  tokenHash    String    @unique @map("token_hash") @db.VarChar(64)
  /// AI æœåŠ¡å•†æ ‡è¯†ï¼ˆopenai, anthropic, google ç­‰ï¼‰
  vendor       String    @db.VarChar(50)
  /// å…³è”çš„ ProviderKey ID
  keyId        String    @map("key_id") @db.Uuid
  /// è®¿é—®æ§åˆ¶æ ‡ç­¾
  tags         String[]
  /// Token è¿‡æœŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰
  expiresAt    DateTime? @map("expires_at") @db.Timestamptz(6)
  /// Token æ’¤é”€æ—¶é—´ï¼ˆnull è¡¨ç¤ºæœ‰æ•ˆï¼‰
  revokedAt    DateTime? @map("revoked_at") @db.Timestamptz(6)
  /// æœ€åä½¿ç”¨æ—¶é—´
  lastUsedAt   DateTime? @map("last_used_at") @db.Timestamptz(6)
  /// è¯·æ±‚è®¡æ•°
  requestCount Int       @default(0) @map("request_count")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  bot         Bot         @relation(fields: [botId], references: [id], onDelete: Cascade)
  providerKey ProviderKey @relation(fields: [keyId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([botId])
  @@index([keyId])
  @@index([vendor])
  @@index([expiresAt])
  @@index([revokedAt])
  @@map("b_proxy_token")
}

/// User Message System
/// ç”¨æˆ·æ¶ˆæ¯ç³»ç»Ÿ - æ”¯æŒç³»ç»Ÿé€šçŸ¥ã€ç”¨æˆ·é—´æ¶ˆæ¯ç­‰
model Message {
  id        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  type      String    @db.VarChar(50) // SYSTEM, USER, NOTIFICATION, MILESTONE, ACHIEVEMENT
  title     String?   @db.VarChar(255)
  content   Json // æ¶ˆæ¯å†…å®¹ï¼ˆæ”¯æŒå¯Œæ–‡æœ¬ã€å¤šè¯­è¨€ï¼‰
  senderId  String?   @map("sender_id") @db.Uuid // null for system messages
  metadata  Json? // é¢å¤–å…ƒæ•°æ®ï¼ˆå¦‚å…³è”çš„é—®é¢˜IDã€å¾½ç« IDç­‰ï¼‰
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  isDeleted Boolean   @default(false) @map("is_deleted")
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  sender     UserInfo?          @relation("SentMessages", fields: [senderId], references: [id], onDelete: SetNull)
  recipients MessageRecipient[]

  @@index([type])
  @@index([senderId])
  @@index([createdAt])
  @@index([isDeleted])
  @@map("message")
}

/// Message Recipient - æ¶ˆæ¯æ¥æ”¶è®°å½•
/// è®°å½•æ¯ä¸ªç”¨æˆ·æ¥æ”¶åˆ°çš„æ¶ˆæ¯åŠå…¶é˜…è¯»çŠ¶æ€
model MessageRecipient {
  id        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  messageId String    @map("message_id") @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  isRead    Boolean   @default(false) @map("is_read")
  readAt    DateTime? @map("read_at") @db.Timestamptz(6)

  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  isDeleted Boolean   @default(false) @map("is_deleted")
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  message Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    UserInfo @relation("ReceivedMessages", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([userId, isRead])
  @@index([messageId])
  @@index([isDeleted])
  @@index([userId, isRead, isDeleted]) // Composite index for unread message count queries
  @@map("message_recipient")
}

// ============================================================================
// Operation Log System - æ“ä½œæ—¥å¿—ç³»ç»Ÿ
// ============================================================================

enum OperateType {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  START
  STOP
  EXPORT
  IMPORT

  @@map("operate_type")
}

enum OperateTarget {
  BOT
  PROVIDER_KEY
  USER
  PERSONA_TEMPLATE
  SYSTEM

  @@map("operate_target")
}

/// OperateLog - æ“ä½œæ—¥å¿—
/// è®°å½•ç”¨æˆ·çš„æ“ä½œè¡Œä¸ºï¼Œç”¨äºå®¡è®¡å’Œè¿½è¸ª
model OperateLog {
  id          String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId      String        @map("user_id") @db.Uuid
  operateType OperateType   @map("operate_type")
  target      OperateTarget
  targetId    String?       @map("target_id") @db.Uuid
  targetName  String?       @map("target_name") @db.VarChar(255)
  detail      Json?
  ipAddress   String?       @map("ip_address") @db.VarChar(45)
  userAgent   String?       @map("user_agent") @db.VarChar(500)
  createdAt   DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)

  user UserInfo @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([operateType])
  @@index([target])
  @@index([targetId])
  @@index([createdAt(sort: Desc)])
  @@map("operate_log")
}

// ============================================================================
// Channel Definition System - æ¸ é“å®šä¹‰ç³»ç»Ÿ
// ============================================================================

/// ChannelDefinition - æ¸ é“å®šä¹‰
/// å­˜å‚¨å„ç§æ¶ˆæ¯æ¸ é“çš„é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ‰€éœ€çš„å‡­è¯å­—æ®µ
model ChannelDefinition {
  id               String   @id @db.VarChar(50) // e.g., "feishu", "telegram", "discord"
  label            String   @db.VarChar(100) // Display name
  icon             String   @db.VarChar(10) // Emoji or short icon code
  popular          Boolean  @default(false) // Whether to show in popular section (default/fallback)
  popularLocales   String[] @default([]) @map("popular_locales") // Locales where this channel is popular, e.g., ["zh-CN", "en"]
  tokenHint        String   @map("token_hint") @db.VarChar(500) // Help text for token
  tokenPlaceholder String   @map("token_placeholder") @db.VarChar(255) // Placeholder text
  helpUrl          String?  @map("help_url") @db.VarChar(500) // Documentation URL
  helpText         String?  @map("help_text") @db.VarChar(255) // Help link text
  sortOrder        Int      @default(0) @map("sort_order") // Display order

  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  credentialFields ChannelCredentialField[]

  @@index([popular])
  @@index([sortOrder])
  @@index([isDeleted])
  @@map("b_channel_definition")
}

/// ChannelCredentialField - æ¸ é“å‡­è¯å­—æ®µ
/// å®šä¹‰æ¯ä¸ªæ¸ é“æ‰€éœ€çš„å‡­è¯å­—æ®µé…ç½®
model ChannelCredentialField {
  id          String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  channelId   String  @map("channel_id") @db.VarChar(50)
  key         String  @db.VarChar(50) // Field key, e.g., "appId", "appSecret"
  label       String  @db.VarChar(100) // Display label
  placeholder String  @db.VarChar(255) // Placeholder text
  fieldType   String  @default("text") @map("field_type") @db.VarChar(20) // "text" or "password"
  required    Boolean @default(true) // Whether field is required
  sortOrder   Int     @default(0) @map("sort_order") // Display order within channel

  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  channel ChannelDefinition @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([channelId, key])
  @@index([channelId])
  @@index([sortOrder])
  @@index([isDeleted])
  @@map("b_channel_credential_field")
}

// ============================================================================
// Plugin System - æ’ä»¶ç³»ç»Ÿ
// ============================================================================

/// æ’ä»¶åˆ†ç±»
enum PluginCategory {
  BROWSER // æµè§ˆå™¨è‡ªåŠ¨åŒ–
  FILESYSTEM // æ–‡ä»¶ç³»ç»Ÿ
  DATABASE // æ•°æ®åº“
  API // API é›†æˆ
  COMMUNICATION // é€šè®¯å·¥å…·
  DEVELOPMENT // å¼€å‘å·¥å…·
  CUSTOM // è‡ªå®šä¹‰

  @@map("plugin_category")
}

/// Plugin - æ’ä»¶å®šä¹‰
/// å­˜å‚¨æ’ä»¶çš„å…ƒæ•°æ®å’Œé…ç½®æ¨¡æ¿
model Plugin {
  id            String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name          String         @db.VarChar(100)
  slug          String         @unique @db.VarChar(100)
  description   String?        @db.Text
  version       String         @db.VarChar(20)
  author        String?        @db.VarChar(100)
  category      PluginCategory
  region        String         @default("global") @db.VarChar(20) // global, cn, en
  configSchema  Json?          @map("config_schema") // JSON Schema for plugin config
  defaultConfig Json?          @map("default_config") // Default configuration
  mcpConfig     Json?          @map("mcp_config") // MCP server configuration
  isOfficial    Boolean        @default(false) @map("is_official")
  isEnabled     Boolean        @default(true) @map("is_enabled")
  downloadUrl   String?        @map("download_url") @db.VarChar(500)
  iconEmoji     String?        @map("icon_emoji") @db.VarChar(10)
  iconUrl       String?        @map("icon_url") @db.VarChar(500)

  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  installations BotPlugin[]

  @@index([category])
  @@index([region])
  @@index([isOfficial])
  @@index([isEnabled])
  @@index([isDeleted])
  @@map("b_plugin")
}

/// BotPlugin - Bot ä¸ Plugin çš„å…³è”è¡¨
/// è®°å½• Bot å®‰è£…çš„æ’ä»¶åŠå…¶é…ç½®
model BotPlugin {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  botId     String   @map("bot_id") @db.Uuid
  pluginId  String   @map("plugin_id") @db.Uuid
  config    Json? // Plugin instance configuration
  isEnabled Boolean  @default(true) @map("is_enabled")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  bot    Bot    @relation(fields: [botId], references: [id], onDelete: Cascade)
  plugin Plugin @relation(fields: [pluginId], references: [id], onDelete: Cascade)

  @@unique([botId, pluginId])
  @@index([botId])
  @@index([pluginId])
  @@index([isEnabled])
  @@map("b_bot_plugin")
}

/// SkillType - æŠ€èƒ½ç±»å‹/åˆ†ç±»
/// ç”¨äºå¯¹æŠ€èƒ½è¿›è¡Œåˆ†ç±»ç®¡ç†ï¼Œæ”¯æŒä¸­è‹±æ–‡åç§°
model SkillType {
  id            String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  /// ç±»å‹æ ‡è¯†ï¼ˆå¦‚ coding-agents, git-githubï¼‰
  slug          String  @unique @db.VarChar(100)
  /// è‹±æ–‡åç§°ï¼ˆå¦‚ Coding Agents & IDEsï¼‰
  name          String  @db.VarChar(200)
  /// ä¸­æ–‡åç§°
  nameZh        String? @map("name_zh") @db.VarChar(200)
  /// è‹±æ–‡æè¿°
  description   String? @db.Text
  /// ä¸­æ–‡æè¿°
  descriptionZh String? @map("description_zh") @db.Text
  /// å›¾æ ‡ï¼ˆemoji æˆ–å›¾æ ‡åç§°ï¼‰
  icon          String? @db.VarChar(50)
  /// æ’åºæƒé‡ï¼ˆè¶Šå°è¶Šé å‰ï¼‰
  sortOrder     Int     @default(0) @map("sort_order")

  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  skills Skill[]

  @@index([slug])
  @@index([sortOrder])
  @@index([isDeleted])
  @@map("b_skill_type")
}

/// Skill - è‡ªå®šä¹‰æŠ€èƒ½å®šä¹‰
/// ç”¨æˆ·å¯ä»¥åˆ›å»ºè‡ªå®šä¹‰æŠ€èƒ½ä¾› Bot ä½¿ç”¨
/// æ”¯æŒç³»ç»Ÿé¢„è®¾ã€ç”¨æˆ·è‡ªå®šä¹‰å’Œå¤–éƒ¨åŒæ­¥ï¼ˆå¦‚ OpenClawï¼‰
model Skill {
  id            String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name          String  @db.VarChar(100)
  /// ä¸­æ–‡åç§°ï¼ˆç¿»è¯‘è‡ª nameï¼‰
  nameZh        String? @map("name_zh") @db.VarChar(200)
  slug          String  @db.VarChar(100)
  /// è‹±æ–‡æè¿°ï¼ˆåŸå§‹æè¿°ï¼‰
  description   String? @db.Text
  /// ä¸­æ–‡æè¿°ï¼ˆç¿»è¯‘è‡ª descriptionï¼‰
  descriptionZh String? @map("description_zh") @db.Text
  version       String  @default("1.0.0") @db.VarChar(20)

  // æŠ€èƒ½ç±»å‹å…³è”
  skillTypeId String?    @map("skill_type_id") @db.Uuid
  skillType   SkillType? @relation(fields: [skillTypeId], references: [id], onDelete: SetNull)

  // æŠ€èƒ½å®šä¹‰ (JSON)
  // å¯¹äº tool ç±»å‹: { name, description, inputSchema, handler }
  // å¯¹äº prompt ç±»å‹: { template, variables }
  // å¯¹äº workflow ç±»å‹: { steps, triggers }
  definition Json @db.JsonB

  // ç¤ºä¾‹ç”¨æ³•
  examples Json? @db.JsonB

  // æ˜¯å¦ä¸ºç³»ç»Ÿé¢„è®¾
  isSystem  Boolean @default(false) @map("is_system")
  isEnabled Boolean @default(true) @map("is_enabled")

  // åˆ›å»ºè€…
  createdById String? @map("created_by_id") @db.Uuid

  // ============ å¤–éƒ¨æ¥æºå­—æ®µï¼ˆç”¨äºåŒæ­¥ OpenClaw ç­‰å¤–éƒ¨æŠ€èƒ½åº“ï¼‰============
  /// å¤–éƒ¨æ¥æºæ ‡è¯†ï¼ˆå¦‚ openclaw, clawhubï¼‰
  source       String?   @db.VarChar(50)
  /// å¤–éƒ¨æ¥æº URLï¼ˆå¦‚ GitHub ä»“åº“é“¾æ¥ï¼‰
  sourceUrl    String?   @map("source_url") @db.VarChar(500)
  /// æŠ€èƒ½ä½œè€…ï¼ˆå¤–éƒ¨æ¥æºçš„ä½œè€…ï¼‰
  author       String?   @db.VarChar(100)
  /// æœ€ååŒæ­¥æ—¶é—´
  lastSyncedAt DateTime? @map("last_synced_at") @db.Timestamptz(6)

  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  installations BotSkill[]

  @@unique([slug, createdById])
  @@unique([source, slug], name: "b_skill_source_slug_key")
  @@index([skillTypeId])
  @@index([isSystem])
  @@index([isEnabled])
  @@index([createdById])
  @@index([isDeleted])
  @@index([source])
  @@index([lastSyncedAt])
  @@map("b_skill")
}

/// BotSkill - Bot ä¸ Skill çš„å…³è”è¡¨
/// è®°å½• Bot å®‰è£…çš„æŠ€èƒ½åŠå…¶é…ç½®
model BotSkill {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  botId     String   @map("bot_id") @db.Uuid
  skillId   String   @map("skill_id") @db.Uuid
  config    Json? // Skill instance configuration overrides
  isEnabled Boolean  @default(true) @map("is_enabled")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  bot   Bot   @relation(fields: [botId], references: [id], onDelete: Cascade)
  skill Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([botId, skillId])
  @@index([botId])
  @@index([skillId])
  @@index([isEnabled])
  @@map("b_bot_skill")
}

// ============================================================================
// Bot Channel System - Bot æ¸ é“ç³»ç»Ÿ
// ============================================================================

/// æ¸ é“è¿æ¥çŠ¶æ€
enum ChannelConnectionStatus {
  DISCONNECTED // æœªè¿æ¥
  CONNECTING // è¿æ¥ä¸­
  CONNECTED // å·²è¿æ¥
  ERROR // è¿æ¥é”™è¯¯

  @@map("channel_connection_status")
}

// ============================================================================
// Model Pricing System - AI æ¨¡å‹å®šä»·ç³»ç»Ÿ
// ============================================================================

/// ModelPricing - AI æ¨¡å‹å®šä»·ä¸èƒ½åŠ›ç›®å½•
/// å­˜å‚¨å„ AI æ¨¡å‹çš„å®šä»·ä¿¡æ¯ã€èƒ½åŠ›è¯„åˆ†å’Œç‰¹æ€§æ”¯æŒï¼Œç”¨äºæˆæœ¬ä¼°ç®—å’Œæ™ºèƒ½è·¯ç”±
/// ä»·æ ¼å•ä½ï¼šç¾å…ƒ/ç™¾ä¸‡ tokens
model ModelPricing {
  id          String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  /// æ¨¡å‹åç§°ï¼ˆå¦‚ gpt-4o, claude-sonnet-4-20250514ï¼‰
  model       String  @unique @db.VarChar(100)
  /// æœåŠ¡å•†æ ‡è¯†ï¼ˆopenai, anthropic, google, deepseek ç­‰ï¼‰
  vendor      String  @db.VarChar(50)
  /// æ¨¡å‹æ˜¾ç¤ºåç§°
  displayName String? @map("display_name") @db.VarChar(255)
  /// æ¨¡å‹æè¿°
  description String? @db.Text

  // ============ å®šä»·ä¿¡æ¯ï¼ˆç¾å…ƒ/ç™¾ä¸‡ tokensï¼‰============
  /// è¾“å…¥ token ä»·æ ¼
  inputPrice      Decimal  @map("input_price") @db.Decimal(10, 6)
  /// è¾“å‡º token ä»·æ ¼
  outputPrice     Decimal  @map("output_price") @db.Decimal(10, 6)
  /// ç¼“å­˜è¯»å–ä»·æ ¼ï¼ˆAnthropic Cache Controlï¼‰
  cacheReadPrice  Decimal? @map("cache_read_price") @db.Decimal(10, 6)
  /// ç¼“å­˜å†™å…¥ä»·æ ¼ï¼ˆAnthropic Cache Controlï¼‰
  cacheWritePrice Decimal? @map("cache_write_price") @db.Decimal(10, 6)
  /// æ€è€ƒ token ä»·æ ¼ï¼ˆAnthropic Extended Thinkingï¼‰
  thinkingPrice   Decimal? @map("thinking_price") @db.Decimal(10, 6)

  // ============ èƒ½åŠ›è¯„åˆ†ï¼ˆ0-100ï¼‰============
  /// æ¨ç†èƒ½åŠ›è¯„åˆ†
  reasoningScore  Int @default(50) @map("reasoning_score")
  /// ç¼–ç èƒ½åŠ›è¯„åˆ†
  codingScore     Int @default(50) @map("coding_score")
  /// åˆ›é€ åŠ›è¯„åˆ†
  creativityScore Int @default(50) @map("creativity_score")
  /// å“åº”é€Ÿåº¦è¯„åˆ†
  speedScore      Int @default(50) @map("speed_score")
  /// ä¸Šä¸‹æ–‡é•¿åº¦ï¼ˆK tokensï¼‰
  contextLength   Int @default(128) @map("context_length")

  // ============ ç‰¹æ€§æ”¯æŒ ============
  /// æ˜¯å¦æ”¯æŒ Extended Thinkingï¼ˆAnthropicï¼‰
  supportsExtendedThinking Boolean @default(false) @map("supports_extended_thinking")
  /// æ˜¯å¦æ”¯æŒ Cache Controlï¼ˆAnthropicï¼‰
  supportsCacheControl     Boolean @default(false) @map("supports_cache_control")
  /// æ˜¯å¦æ”¯æŒè§†è§‰/å¤šæ¨¡æ€
  supportsVision           Boolean @default(false) @map("supports_vision")
  /// æ˜¯å¦æ”¯æŒ Function Calling
  supportsFunctionCalling  Boolean @default(true) @map("supports_function_calling")
  /// æ˜¯å¦æ”¯æŒæµå¼å“åº”
  supportsStreaming        Boolean @default(true) @map("supports_streaming")

  // ============ æ¨èåœºæ™¯ ============
  /// æ¨èä½¿ç”¨åœºæ™¯ï¼ˆJSON æ•°ç»„ï¼‰
  /// å¦‚ ["deep-reasoning", "coding", "general-purpose"]
  recommendedScenarios Json? @map("recommended_scenarios") @db.JsonB

  // ============ çŠ¶æ€ ============
  /// æ˜¯å¦å¯ç”¨
  isEnabled       Boolean   @default(true) @map("is_enabled")
  /// æ˜¯å¦å·²å¼ƒç”¨
  isDeprecated    Boolean   @default(false) @map("is_deprecated")
  /// å¼ƒç”¨æ—¥æœŸ
  deprecationDate DateTime? @map("deprecation_date") @db.Timestamptz(6)
  /// ä»·æ ¼æ›´æ–°æ—¶é—´
  priceUpdatedAt  DateTime  @default(now()) @map("price_updated_at") @db.Timestamptz(6)
  /// å¤‡æ³¨
  notes           String?   @db.Text
  /// å…¶ä»–æ‰©å±•å…ƒæ•°æ®
  metadata        Json?     @db.JsonB

  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  @@index([vendor])
  @@index([isEnabled])
  @@index([isDeprecated])
  @@index([isDeleted])
  @@index([supportsExtendedThinking])
  @@index([supportsCacheControl])
  @@map("b_model_pricing")
}

// ============================================================================
// Model Routing System - æ¨¡å‹è·¯ç”±ç³»ç»Ÿ
// ============================================================================

/// è·¯ç”±ç±»å‹æšä¸¾
enum ModelRoutingType {
  FUNCTION_ROUTE // åŠŸèƒ½è·¯ç”±ï¼šæ ¹æ®æ¶ˆæ¯å†…å®¹é€‰æ‹©æ¨¡å‹
  LOAD_BALANCE // è´Ÿè½½å‡è¡¡ï¼šå¤šæ¨¡å‹åˆ†æµ
  FAILOVER // æ•…éšœè½¬ç§»ï¼šä¸»å¤‡åˆ‡æ¢

  @@map("model_routing_type")
}

/// BotModelRouting - Bot æ¨¡å‹è·¯ç”±é…ç½®
/// å­˜å‚¨ Bot çš„æ¨¡å‹è·¯ç”±è§„åˆ™ï¼Œæ”¯æŒåŠŸèƒ½è·¯ç”±ã€è´Ÿè½½å‡è¡¡ã€æ•…éšœè½¬ç§»
model BotModelRouting {
  id          String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  botId       String           @map("bot_id") @db.Uuid
  /// è·¯ç”±ç±»å‹
  routingType ModelRoutingType @map("routing_type")
  /// è·¯ç”±åç§°ï¼ˆç”¨äºæ ‡è¯†ï¼‰
  name        String           @db.VarChar(100)
  /// è·¯ç”±é…ç½® (JSON)
  /// åŠŸèƒ½è·¯ç”±: { rules: [...], defaultTarget: {...} }
  /// è´Ÿè½½å‡è¡¡: { strategy: "round_robin"|"weighted"|"least_latency", targets: [...] }
  /// æ•…éšœè½¬ç§»: { primary: {...}, fallbackChain: [...], retry: {...} }
  config      Json             @db.JsonB
  /// ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
  priority    Int              @default(100)
  /// æ˜¯å¦å¯ç”¨
  isEnabled   Boolean          @default(true) @map("is_enabled")

  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId])
  @@index([routingType])
  @@index([priority])
  @@index([isEnabled])
  @@index([isDeleted])
  @@map("b_bot_model_routing")
}

/// BotChannel - Bot æ¸ é“é…ç½®
/// å­˜å‚¨ Bot çš„æ¸ é“è¿æ¥é…ç½®ï¼ŒåŒ…æ‹¬åŠ å¯†çš„å‡­è¯
/// ä¸€ä¸ª Bot å¯ä»¥è¿æ¥å¤šä¸ªæ¸ é“ï¼ˆå¦‚åŒæ—¶è¿æ¥é£ä¹¦å’Œ Telegramï¼‰
model BotChannel {
  id                   String                  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  botId                String                  @map("bot_id") @db.Uuid
  channelType          String                  @map("channel_type") @db.VarChar(50) // feishu, telegram, discord, etc.
  name                 String                  @db.VarChar(255) // æ¸ é“åç§°ï¼Œç”¨äºåŒºåˆ†åŒç±»å‹å¤šä¸ªæ¸ é“
  credentialsEncrypted Bytes                   @map("credentials_encrypted") // AES-256-GCM åŠ å¯†çš„å‡­è¯ JSON
  config               Json? // æ¸ é“ç‰¹å®šé…ç½®ï¼ˆå¦‚ requireMention, replyInThread ç­‰ï¼‰
  isEnabled            Boolean                 @default(true) @map("is_enabled")
  connectionStatus     ChannelConnectionStatus @default(DISCONNECTED) @map("connection_status")
  lastConnectedAt      DateTime?               @map("last_connected_at") @db.Timestamptz(6)
  lastError            String?                 @map("last_error") @db.Text

  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, channelType, name])
  @@index([botId])
  @@index([channelType])
  @@index([isEnabled])
  @@index([connectionStatus])
  @@index([isDeleted])
  @@map("b_bot_channel")
}

// ============================================================================
// Hybrid Architecture - Routing Configuration System
// æ··åˆæ¶æ„ - è·¯ç”±é…ç½®ç³»ç»Ÿ
// ============================================================================

/// CapabilityTag - èƒ½åŠ›æ ‡ç­¾
/// å®šä¹‰è·¯ç”±èƒ½åŠ›æ ‡ç­¾åŠå…¶è¦æ±‚ï¼Œç”¨äºæ™ºèƒ½è·¯ç”±å†³ç­–
model CapabilityTag {
  id          String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  /// æ ‡ç­¾æ ‡è¯†ï¼ˆå¦‚ deep-reasoning, cost-optimized, web-searchï¼‰
  tagId       String  @unique @map("tag_id") @db.VarChar(50)
  /// æ˜¾ç¤ºåç§°
  name        String  @db.VarChar(100)
  /// æ ‡ç­¾æè¿°
  description String? @db.Text

  /// åˆ†ç±»ï¼šreasoning | search | code | vision | audio | cost | context
  category String @db.VarChar(50)

  /// è·¯ç”±ä¼˜å…ˆçº§ï¼ˆæ•°å€¼è¶Šé«˜ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
  priority Int @default(50)

  // ============ è·¯ç”±è¦æ±‚ ============
  /// è¦æ±‚çš„åè®®ç±»å‹ï¼šopenai-compatible | anthropic-native | null
  requiredProtocol String? @map("required_protocol") @db.VarChar(50)
  /// è¦æ±‚çš„ Skillsï¼ˆJSON æ•°ç»„ï¼‰å¦‚ ["web_search", "code_runner"]
  requiredSkills   Json?   @map("required_skills") @db.JsonB
  /// è¦æ±‚çš„æ¨¡å‹åˆ—è¡¨ï¼ˆJSON æ•°ç»„ï¼‰å¦‚ ["claude-sonnet-4-*", "gpt-4o"]
  requiredModels   Json?   @map("required_models") @db.JsonB

  // ============ ç‰¹æ€§è¦æ±‚ ============
  /// æ˜¯å¦è¦æ±‚ Extended Thinking
  requiresExtendedThinking Boolean @default(false) @map("requires_extended_thinking")
  /// æ˜¯å¦è¦æ±‚ Cache Control
  requiresCacheControl     Boolean @default(false) @map("requires_cache_control")
  /// æ˜¯å¦è¦æ±‚è§†è§‰èƒ½åŠ›
  requiresVision           Boolean @default(false) @map("requires_vision")

  /// å•æ¬¡è¯·æ±‚æœ€å¤§æˆæœ¬çº¦æŸï¼ˆç¾å…ƒï¼‰
  maxCostPerMToken Decimal? @map("max_cost_per_m_token") @db.Decimal(10, 6)

  // ============ çŠ¶æ€ ============
  /// æ˜¯å¦å¯ç”¨
  isActive  Boolean @default(true) @map("is_active")
  /// æ˜¯å¦ä¸ºå†…ç½®æ ‡ç­¾
  isBuiltin Boolean @default(false) @map("is_builtin")

  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  @@index([category])
  @@index([isActive])
  @@index([isBuiltin])
  @@index([isDeleted])
  @@map("b_capability_tag")
}

/// FallbackChain - Fallback é“¾é…ç½®
/// å®šä¹‰æ¨¡å‹é™çº§ç­–ç•¥ï¼Œæ”¯æŒå¤šæ¨¡å‹æ•…éšœè½¬ç§»
model FallbackChain {
  id          String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  /// é“¾æ ‡è¯†ï¼ˆå¦‚ default, deep-reasoning, cost-optimizedï¼‰
  chainId     String  @unique @map("chain_id") @db.VarChar(50)
  /// æ˜¾ç¤ºåç§°
  name        String  @db.VarChar(100)
  /// é“¾æè¿°
  description String? @db.Text

  /// æ¨¡å‹é“¾é…ç½®ï¼ˆJSON æ•°ç»„ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
  /// [{ vendor: "anthropic", model: "claude-sonnet-4", protocol: "anthropic-native", features: {...} }]
  models Json @db.JsonB

  // ============ è§¦å‘æ¡ä»¶ ============
  /// è§¦å‘ Fallback çš„ HTTP çŠ¶æ€ç ï¼ˆJSON æ•°ç»„ï¼‰
  triggerStatusCodes Json @default("[429, 500, 502, 503, 504]") @map("trigger_status_codes") @db.JsonB
  /// è§¦å‘ Fallback çš„é”™è¯¯ç±»å‹ï¼ˆJSON æ•°ç»„ï¼‰
  triggerErrorTypes  Json @default("[\"rate_limit\", \"overloaded\", \"timeout\"]") @map("trigger_error_types") @db.JsonB
  /// è§¦å‘ Fallback çš„è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  triggerTimeoutMs   Int  @default(60000) @map("trigger_timeout_ms")

  // ============ è¡Œä¸ºé…ç½® ============
  /// æœ€å¤§é‡è¯•æ¬¡æ•°
  maxRetries       Int     @default(3) @map("max_retries")
  /// é‡è¯•é—´éš”ï¼ˆæ¯«ç§’ï¼‰
  retryDelayMs     Int     @default(2000) @map("retry_delay_ms")
  /// æ˜¯å¦ä¿æŒåè®®ä¸€è‡´ï¼ˆé™çº§æ—¶æ˜¯å¦å…è®¸åˆ‡æ¢åè®®ï¼‰
  preserveProtocol Boolean @default(false) @map("preserve_protocol")

  // ============ çŠ¶æ€ ============
  /// æ˜¯å¦å¯ç”¨
  isActive  Boolean @default(true) @map("is_active")
  /// æ˜¯å¦ä¸ºå†…ç½®é“¾
  isBuiltin Boolean @default(false) @map("is_builtin")

  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  @@index([isActive])
  @@index([isBuiltin])
  @@index([isDeleted])
  @@map("b_fallback_chain")
}

/// CostStrategy - æˆæœ¬ç­–ç•¥é…ç½®
/// å®šä¹‰æˆæœ¬ä¼˜åŒ–ç­–ç•¥ï¼Œç”¨äºæ¨¡å‹é€‰æ‹©å†³ç­–
model CostStrategy {
  id          String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  /// ç­–ç•¥æ ‡è¯†ï¼ˆå¦‚ lowest-cost, best-value, performance-first, balancedï¼‰
  strategyId  String  @unique @map("strategy_id") @db.VarChar(50)
  /// æ˜¾ç¤ºåç§°
  name        String  @db.VarChar(100)
  /// ç­–ç•¥æè¿°
  description String? @db.Text

  // ============ ä¼˜åŒ–æƒé‡ï¼ˆ0-1ï¼Œæ€»å’Œä¸º 1ï¼‰============
  /// æˆæœ¬æƒé‡
  costWeight        Decimal @default(0.5) @map("cost_weight") @db.Decimal(3, 2)
  /// æ€§èƒ½æƒé‡
  performanceWeight Decimal @default(0.3) @map("performance_weight") @db.Decimal(3, 2)
  /// èƒ½åŠ›æƒé‡
  capabilityWeight  Decimal @default(0.2) @map("capability_weight") @db.Decimal(3, 2)

  // ============ çº¦æŸæ¡ä»¶ ============
  /// å•æ¬¡è¯·æ±‚æœ€å¤§æˆæœ¬ï¼ˆç¾å…ƒï¼‰
  maxCostPerRequest  Decimal? @map("max_cost_per_request") @db.Decimal(10, 6)
  /// æœ€å¤§å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
  maxLatencyMs       Int?     @map("max_latency_ms")
  /// æœ€ä½èƒ½åŠ›è¯„åˆ†
  minCapabilityScore Int?     @map("min_capability_score")

  /// åœºæ™¯æƒé‡é…ç½®ï¼ˆJSONï¼‰
  /// { "reasoning": 0.5, "coding": 0.3, "creativity": 0.2, "speed": 0.5 }
  scenarioWeights Json? @map("scenario_weights") @db.JsonB

  // ============ çŠ¶æ€ ============
  /// æ˜¯å¦å¯ç”¨
  isActive  Boolean @default(true) @map("is_active")
  /// æ˜¯å¦ä¸ºå†…ç½®ç­–ç•¥
  isBuiltin Boolean @default(false) @map("is_builtin")

  isDeleted Boolean   @default(false) @map("is_deleted")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  @@index([isActive])
  @@index([isBuiltin])
  @@index([isDeleted])
  @@map("b_cost_strategy")
}

/// BotRoutingConfig - Bot è·¯ç”±é…ç½®
/// å­˜å‚¨ Bot çš„æ™ºèƒ½è·¯ç”±ã€Fallback å’Œæˆæœ¬æ§åˆ¶é…ç½®
model BotRoutingConfig {
  id    String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  botId String @unique @map("bot_id") @db.Uuid

  // ============ è·¯ç”±é…ç½® ============
  /// æ˜¯å¦å¯ç”¨æ™ºèƒ½è·¯ç”±
  routingEnabled Boolean @default(true) @map("routing_enabled")
  /// è·¯ç”±æ¨¡å¼ï¼šauto | manual | cost-optimized
  routingMode    String  @default("auto") @map("routing_mode") @db.VarChar(20)

  // ============ Fallback é…ç½® ============
  /// æ˜¯å¦å¯ç”¨ Fallback
  fallbackEnabled Boolean @default(true) @map("fallback_enabled")
  /// é»˜è®¤ Fallback é“¾ ID
  fallbackChainId String? @map("fallback_chain_id") @db.VarChar(50)

  // ============ æˆæœ¬æ§åˆ¶é…ç½® ============
  /// æ˜¯å¦å¯ç”¨æˆæœ¬æ§åˆ¶
  costControlEnabled Boolean  @default(false) @map("cost_control_enabled")
  /// æˆæœ¬ç­–ç•¥ ID
  costStrategyId     String?  @map("cost_strategy_id") @db.VarChar(50)
  /// æ¯æ—¥é¢„ç®—ï¼ˆç¾å…ƒï¼‰
  dailyBudget        Decimal? @map("daily_budget") @db.Decimal(10, 2)
  /// æ¯æœˆé¢„ç®—ï¼ˆç¾å…ƒï¼‰
  monthlyBudget      Decimal? @map("monthly_budget") @db.Decimal(10, 2)
  /// é¢„ç®—å‘Šè­¦é˜ˆå€¼ï¼ˆ0-1ï¼‰
  alertThreshold     Decimal? @default(0.8) @map("alert_threshold") @db.Decimal(3, 2)
  /// æ˜¯å¦å¯ç”¨è‡ªåŠ¨é™çº§
  autoDowngrade      Boolean  @default(false) @map("auto_downgrade")
  /// é™çº§ç›®æ ‡æ¨¡å‹
  downgradeModel     String?  @map("downgrade_model") @db.VarChar(100)

  // ============ å¤æ‚åº¦è·¯ç”±é…ç½® ============
  /// æ˜¯å¦å¯ç”¨å¤æ‚åº¦è·¯ç”±
  complexityRoutingEnabled  Boolean @default(false) @map("complexity_routing_enabled")
  /// å¤æ‚åº¦è·¯ç”±é…ç½® ID
  complexityRoutingConfigId String? @map("complexity_routing_config_id") @db.VarChar(50)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId])
  @@index([routingEnabled])
  @@index([costControlEnabled])
  @@index([complexityRoutingEnabled])
  @@map("b_bot_routing_config")
}

/// ComplexityRoutingConfig - å¤æ‚åº¦è·¯ç”±é…ç½®
/// å­˜å‚¨åŸºäºæ¶ˆæ¯å¤æ‚åº¦çš„æ¨¡å‹è·¯ç”±é…ç½®
model ComplexityRoutingConfig {
  id          String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  /// é…ç½®å”¯ä¸€æ ‡è¯†ç¬¦
  configId    String  @unique @map("config_id") @db.VarChar(50)
  /// é…ç½®åç§°
  name        String  @db.VarChar(100)
  /// é…ç½®æè¿°
  description String? @db.Text

  // ============ æ¨¡å‹é…ç½® ============
  /// å„å¤æ‚åº¦å¯¹åº”çš„æ¨¡å‹é…ç½®ï¼ˆJSONï¼‰
  /// æ ¼å¼: { super_easy: {vendor, model}, easy: {...}, medium: {...}, hard: {...}, super_hard: {...} }
  models Json @db.JsonB

  // ============ åˆ†ç±»å™¨é…ç½® ============
  /// åˆ†ç±»å™¨ä½¿ç”¨çš„æ¨¡å‹
  classifierModel  String @default("deepseek-v3-250324") @map("classifier_model") @db.VarChar(100)
  /// åˆ†ç±»å™¨ä½¿ç”¨çš„ vendor
  classifierVendor String @default("deepseek") @map("classifier_vendor") @db.VarChar(50)

  // ============ è¡Œä¸ºé…ç½® ============
  /// å·¥å…·è°ƒç”¨æ—¶çš„æœ€ä½å¤æ‚åº¦
  toolMinComplexity String? @map("tool_min_complexity") @db.VarChar(20)

  // ============ çŠ¶æ€ ============
  /// æ˜¯å¦å¯ç”¨
  isEnabled Boolean @default(true) @map("is_enabled")
  /// æ˜¯å¦ä¸ºå†…ç½®é…ç½®
  isBuiltin Boolean @default(false) @map("is_builtin")
  /// è½¯åˆ é™¤æ ‡è®°
  isDeleted Boolean @default(false) @map("is_deleted")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([configId])
  @@index([isEnabled])
  @@index([isDeleted])
  @@map("b_complexity_routing_config")
}
